<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gloucestershire Jobs</title>
</head>
<body>

  <script>
// Gloucestershire Jobs Feed Widget - Fixed Version
(function() {
  'use strict';
  
  // Updated URL to your hosted XML
  const FEED_URL = 'https://salmon-meadow-0dcf69803.2.azurestaticapps.net/_hidden/354055.xml';
  
  // Inject styles
  const styles = `
    <style>
      .glos-jobs-widget {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      
      .glos-jobs-header {
        text-align: center;
        margin-bottom: 2rem;
      }
      
      .glos-jobs-header h2 {
        font-size: 2rem;
        color: #1e293b;
        margin-bottom: 0.5rem;
      }
      
      .glos-jobs-header p {
        color: #64748b;
        font-size: 1rem;
      }
      
      .glos-jobs-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }
      
      .glos-search-box {
        flex: 1;
        min-width: 250px;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }
      
      .glos-search-box:focus {
        outline: none;
        border-color: #3b82f6;
      }
      
      .glos-filter-select {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s;
      }
      
      .glos-filter-select:focus {
        outline: none;
        border-color: #3b82f6;
      }
      
      .glos-jobs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      
      .glos-job-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      
      .glos-job-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
      }
      
      .glos-job-card.expanded {
        grid-column: 1 / -1;
      }
      
      .glos-employer-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .glos-employer-badge.glos-city {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      
      .glos-job-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }
      
      .glos-job-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      
      .glos-meta-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        color: #64748b;
      }
      
      .glos-meta-icon {
        width: 16px;
        height: 16px;
      }
      
      .glos-salary-highlight {
        font-size: 1.1rem;
        font-weight: 700;
        color: #059669;
        margin: 0.75rem 0;
      }
      
      .glos-closing-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 0.75rem;
        background: #fef3c7;
        color: #92400e;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 0.75rem;
      }
      
      .glos-closing-badge.urgent {
        background: #fee2e2;
        color: #991b1b;
      }
      
      .glos-job-details {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #f1f5f9;
        display: none;
      }
      
      .glos-job-card.expanded .glos-job-details {
        display: block;
      }
      
      .glos-detail-section {
        margin-bottom: 1.25rem;
      }
      
      .glos-detail-section h4 {
        font-size: 0.95rem;
        font-weight: 700;
        color: #475569;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .glos-detail-section p, .glos-detail-section ul {
        font-size: 0.95rem;
        color: #64748b;
        line-height: 1.6;
      }
      
      .glos-detail-section ul {
        margin-left: 1.25rem;
        margin-top: 0.5rem;
      }
      
      .glos-detail-section li {
        margin-bottom: 0.35rem;
      }
      
      .glos-action-buttons {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
      }
      
      .glos-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.95rem;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }
      
      .glos-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .glos-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
      
      .glos-btn-secondary {
        background: white;
        color: #475569;
        border: 2px solid #e2e8f0;
      }
      
      .glos-btn-secondary:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
      }
      
      .glos-stats-bar {
        display: flex;
        justify-content: space-around;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 1rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
      }
      
      .glos-stat {
        text-align: center;
      }
      
      .glos-stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      
      .glos-stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      
      .glos-loading {
        text-align: center;
        padding: 4rem 2rem;
        color: #64748b;
      }
      
      .glos-loading-spinner {
        border: 4px solid #f1f5f9;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: glos-spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      
      @keyframes glos-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .glos-no-results {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
        font-size: 1.1rem;
      }
      
      @media (max-width: 768px) {
        .glos-jobs-grid {
          grid-template-columns: 1fr;
        }
        
        .glos-jobs-controls {
          flex-direction: column;
        }
        
        .glos-stats-bar {
          flex-direction: column;
        }
      }
    </style>
  `;
  
  // Create container
  const container = document.createElement('div');
  container.className = 'glos-jobs-widget';
  container.innerHTML = styles + `
    <div class="glos-jobs-header">
      <h2>üèõÔ∏è Gloucestershire Council Jobs</h2>
      <p>Find your next opportunity in local government</p>
    </div>
    
    <div id="glos-stats"></div>
    
    <div class="glos-jobs-controls">
      <input 
        type="text" 
        class="glos-search-box" 
        id="glos-search" 
        placeholder="üîç Search jobs by title, location, or keywords..."
      />
      
      <select class="glos-filter-select" id="glos-employer-filter">
        <option value="">All Employers</option>
      </select>
      
      <select class="glos-filter-select" id="glos-salary-filter">
        <option value="">All Salaries</option>
        <option value="0-30000">Under ¬£30k</option>
        <option value="30000-40000">¬£30k - ¬£40k</option>
        <option value="40000-50000">¬£40k - ¬£50k</option>
        <option value="50000-999999">¬£50k+</option>
      </select>
      
      <select class="glos-filter-select" id="glos-sort">
        <option value="closing">Closing Soon</option>
        <option value="salary-high">Highest Salary</option>
        <option value="salary-low">Lowest Salary</option>
        <option value="title">A-Z</option>
      </select>
    </div>
    
    <div id="glos-jobs-container" class="glos-loading">
      <div class="glos-loading-spinner"></div>
      <p>Loading latest opportunities...</p>
    </div>
  `;
  
  // Append to page
  const script = document.currentScript;
  script.parentNode.insertBefore(container, script.nextSibling);
  
  // Job data
  let allJobs = [];
  let filteredJobs = [];
  
  // Parse XML and extract jobs
  function parseJobFeed(xmlText) {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
    const jobNodes = xmlDoc.getElementsByTagName('job');
    
    const jobs = [];
    
    for (let i = 0; i < jobNodes.length; i++) {
      const job = jobNodes[i];
      
      const title = getTagValue(job, 'jobtitle');
      const descriptionHTML = getTagValue(job, 'description');
      const employer = descriptionHTML.includes('Gloucester City Council job') 
        ? 'Gloucester City Council' 
        : 'Gloucestershire County Council';
      
      const salaryMatch = descriptionHTML.match(/Salary[:\s]*(?:&#160;)*([¬£\d,\s\-\.]+(?:per annum|MPS|UPS)?)/i);
      const salary = salaryMatch ? decodeHTML(salaryMatch[1].trim()) : 'Not specified';
      
      const hoursMatch = descriptionHTML.match(/Hours per Week[:\s]*(?:&#160;)*(\d+(?:\.\d+)?)/i);
      const hours = hoursMatch ? hoursMatch[1] : '37';
      
      const locationMatch = descriptionHTML.match(/Job Location[:\s]*(?:&#160;)*([^<]+)/i);
      const location = locationMatch ? decodeHTML(locationMatch[1].trim()) : getTagValue(job, 'locationcity');
      
      const closingDate = getTagValue(job, 'type');
      const daysUntilClose = calculateDaysUntil(closingDate);
      
      const emailMatch = descriptionHTML.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
      const contactEmail = emailMatch ? emailMatch[1] : null;
      
      const salaryRange = parseSalaryRange(salary);
      
      const aboutRole = extractSection(descriptionHTML, 'About (The|the) Role');
      const aboutYou = extractSection(descriptionHTML, 'About You');
      const benefits = extractSection(descriptionHTML, 'About (Us|us)|What we can do for you');
      
      jobs.push({
        id: getTagValue(job, 'externalid'),
        title: decodeHTML(title),
        employer,
        salary,
        salaryMin: salaryRange.min,
        salaryMax: salaryRange.max,
        location: decodeHTML(location),
        hours,
        closingDate,
        daysUntilClose,
        contractType: getTagValue(job, 'jobtenure'),
        applyUrl: getTagValue(job, 'applyURL'),
        contactEmail,
        aboutRole,
        aboutYou,
        benefits,
        fullDescription: descriptionHTML
      });
    }
    
    return jobs;
  }
  
  function getTagValue(node, tagName) {
    const tags = node.getElementsByTagName(tagName);
    return tags.length > 0 ? tags[0].textContent : '';
  }
  
  function decodeHTML(html) {
    if (!html) return '';
    const txt = document.createElement('textarea');
    txt.innerHTML = html;
    return txt.value.replace(/\s+/g, ' ').trim();
  }
  
  function calculateDaysUntil(dateStr) {
    if (!dateStr) return 999;
    const parts = dateStr.split('/');
    if (parts.length !== 3) return 999;
    
    const targetDate = new Date(parts[2], parts[1] - 1, parts[0]);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const diffTime = targetDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
  }
  
  function parseSalaryRange(salaryStr) {
    if (!salaryStr || salaryStr === 'Not specified') {
      return { min: 0, max: 0 };
    }
    
    const numbers = salaryStr.match(/\d{1,3}(?:,\d{3})*/g);
    if (!numbers) return { min: 0, max: 0 };
    
    const amounts = numbers.map(n => parseInt(n.replace(/,/g, '')));
    
    if (amounts.length === 1) {
      return { min: amounts[0], max: amounts[0] };
    } else if (amounts.length >= 2) {
      return { min: Math.min(...amounts), max: Math.max(...amounts) };
    }
    
    return { min: 0, max: 0 };
  }
  
  function extractSection(html, sectionPattern) {
    // Return empty string if html is undefined/null
    if (!html) return '';
    
    try {
      const regex = new RegExp(`<strong[^>]*>${sectionPattern}[^<]*</strong[^>]*>([\\s\\S]*?)(?=<p[^>]*><strong|<div|$)`, 'i');
      const match = html.match(regex);
      
      if (match && match[1]) {
        let content = match[1];
        // Safe replace operations
        content = content.replace(/<br[^>]*>/gi, '\n');
        content = content.replace(/<\/p>/gi, '\n\n');
        content = content.replace(/<li[^>]*>/gi, '‚Ä¢ ');
        content = content.replace(/<\/li>/gi, '\n');
        content = content.replace(/<[^>]+>/g, '');
        content = decodeHTML(content);
        return content.trim().substring(0, 500);
      }
    } catch (e) {
      console.warn('Error extracting section:', e);
    }
    
    return '';
  }
  
  function renderStats(jobs) {
    const statsContainer = document.getElementById('glos-stats');
    
    const jobsWithSalary = jobs.filter(j => j.salaryMin > 0);
    const avgSalary = jobsWithSalary.length > 0
      ? jobsWithSalary.reduce((sum, j) => sum + (j.salaryMin + j.salaryMax) / 2, 0) / jobsWithSalary.length
      : 0;
    
    const closingSoon = jobs.filter(j => j.daysUntilClose <= 7).length;
    
    statsContainer.innerHTML = `
      <div class="glos-stats-bar">
        <div class="glos-stat">
          <div class="glos-stat-number">${jobs.length}</div>
          <div class="glos-stat-label">Open Positions</div>
        </div>
        <div class="glos-stat">
          <div class="glos-stat-number">${avgSalary > 0 ? '¬£' + Math.round(avgSalary / 1000) + 'k' : 'N/A'}</div>
          <div class="glos-stat-label">Avg Salary</div>
        </div>
        <div class="glos-stat">
          <div class="glos-stat-number">${closingSoon}</div>
          <div class="glos-stat-label">Closing This Week</div>
        </div>
      </div>
    `;
  }
  
  function renderJobs(jobs) {
    const container = document.getElementById('glos-jobs-container');
    
    if (jobs.length === 0) {
      container.innerHTML = '<div class="glos-no-results">No jobs match your criteria. Try adjusting your filters.</div>';
      return;
    }
    
    container.innerHTML = '<div class="glos-jobs-grid"></div>';
    const grid = container.querySelector('.glos-jobs-grid');
    
    jobs.forEach(job => {
      const card = createJobCard(job);
      grid.appendChild(card);
    });
  }
  
  function createJobCard(job) {
    const card = document.createElement('div');
    card.className = 'glos-job-card';
    card.dataset.jobId = job.id;
    
    const isCity = job.employer.includes('City');
    const isUrgent = job.daysUntilClose <= 7;
    
    card.innerHTML = `
      <div class="glos-employer-badge ${isCity ? 'glos-city' : ''}">
        ${job.employer.replace('Council', '').trim()}
      </div>
      
      <h3 class="glos-job-title">${job.title}</h3>
      
      <div class="glos-job-meta">
        <span class="glos-meta-item">
          <svg class="glos-meta-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
          </svg>
          ${job.location}
        </span>
        
        <span class="glos-meta-item">
          <svg class="glos-meta-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
          </svg>
          ${job.hours} hours/week
        </span>
        
        <span class="glos-meta-item">
          <svg class="glos-meta-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"></path>
          </svg>
          ${job.contractType}
        </span>
      </div>
      
      ${job.salary !== 'Not specified' ? `<div class="glos-salary-highlight">üí∞ ${job.salary}</div>` : ''}
      
      <div class="glos-closing-badge ${isUrgent ? 'urgent' : ''}">
        ‚è∞ Closes in ${job.daysUntilClose} days (${job.closingDate})
      </div>
      
      <div class="glos-job-details">
        ${job.aboutRole ? `
          <div class="glos-detail-section">
            <h4>üìã About The Role</h4>
            <p>${job.aboutRole}</p>
          </div>
        ` : ''}
        
        ${job.aboutYou ? `
          <div class="glos-detail-section">
            <h4>‚ú® What We're Looking For</h4>
            <p>${job.aboutYou}</p>
          </div>
        ` : ''}
        
        ${job.benefits ? `
          <div class="glos-detail-section">
            <h4>üéÅ Benefits & Perks</h4>
            <p>${job.benefits}</p>
          </div>
        ` : ''}
        
        ${job.contactEmail ? `
          <div class="glos-detail-section">
            <h4>üí¨ Informal Discussion</h4>
            <p><a href="mailto:${job.contactEmail}" style="color: #3b82f6;">${job.contactEmail}</a></p>
          </div>
        ` : ''}
        
        <div class="glos-action-buttons">
          <a href="${job.applyUrl}" target="_blank" class="glos-btn glos-btn-primary">
            Apply Now ‚Üí
          </a>
          <button class="glos-btn glos-btn-secondary glos-collapse-btn">
            Close Details
          </button>
        </div>
      </div>
    `;
    
    card.addEventListener('click', (e) => {
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
      card.classList.toggle('expanded');
    });
    
    const collapseBtn = card.querySelector('.glos-collapse-btn');
    if (collapseBtn) {
      collapseBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        card.classList.remove('expanded');
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    }
    
    return card;
  }
  
  function applyFilters() {
    const searchTerm = document.getElementById('glos-search').value.toLowerCase();
    const employerFilter = document.getElementById('glos-employer-filter').value;
    const salaryFilter = document.getElementById('glos-salary-filter').value;
    const sortMethod = document.getElementById('glos-sort').value;
    
    filteredJobs = allJobs.filter(job => {
      const matchesSearch = !searchTerm || 
        job.title.toLowerCase().includes(searchTerm) ||
        job.location.toLowerCase().includes(searchTerm) ||
        job.employer.toLowerCase().includes(searchTerm);
      
      const matchesEmployer = !employerFilter || job.employer === employerFilter;
      
      let matchesSalary = true;
      if (salaryFilter) {
        const [min, max] = salaryFilter.split('-').map(Number);
        matchesSalary = job.salaryMin >= min && job.salaryMax <= max;
      }
      
      return matchesSearch && matchesEmployer && matchesSalary;
    });
    
    filteredJobs.sort((a, b) => {
      switch(sortMethod) {
        case 'closing':
          return a.daysUntilClose - b.daysUntilClose;
        case 'salary-high':
          return b.salaryMax - a.salaryMax;
        case 'salary-low':
          return a.salaryMin - b.salaryMin;
        case 'title':
          return a.title.localeCompare(b.title);
        default:
          return 0;
      }
    });
    
    renderJobs(filteredJobs);
  }
  
  function setupFilters() {
    const employers = [...new Set(allJobs.map(j => j.employer))];
    const employerFilter = document.getElementById('glos-employer-filter');
    employers.forEach(emp => {
      const option = document.createElement('option');
      option.value = emp;
      option.textContent = emp;
      employerFilter.appendChild(option);
    });
    
    document.getElementById('glos-search').addEventListener('input', applyFilters);
    document.getElementById('glos-employer-filter').addEventListener('change', applyFilters);
    document.getElementById('glos-salary-filter').addEventListener('change', applyFilters);
    document.getElementById('glos-sort').addEventListener('change', applyFilters);
  }
  
  async function init() {
    try {
      const response = await fetch(FEED_URL);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const xmlText = await response.text();
      
      allJobs = parseJobFeed(xmlText);
      filteredJobs = [...allJobs];
      
      renderStats(allJobs);
      setupFilters();
      renderJobs(filteredJobs);
      
    } catch (error) {
      console.error('Error loading jobs:', error);
      document.getElementById('glos-jobs-container').innerHTML = `
        <div class="glos-no-results">
          ‚ö†Ô∏è Unable to load jobs at this time. Please try again later.
          <br><br>
          <small>Error: ${error.message}</small>
        </div>
      `;
    }
  }
  
  init();
  
})();
  </script>
  
</body>
</html>
